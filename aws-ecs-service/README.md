# ECS Service

This module creates an ECS service fronted by a public ALB.

## Terraform managed task definition vs czecs

If the user sets `var.manage_task_definition = true`, Terraform will manage the lifecycle
of the container definition; any external changes are reset on the next Terraform run.

If var.manage_task_definition = false, the user is expected to manage the
container definition external to Terraform (e.g. using [czecs](https://github.com/chanzuckerberg/czecs)). Upon creation,
Terraform will use a stub definition, but from that point forward will ignore any
changes to the definition, allowing external task definition management.

## Example

```hcl
data "aws_route53_zone" "zone" {
  name         = "example.com."
  private_zone = false
}

module "role" {
  source    = "github.com/chanzuckerberg/cztack//aws-iam-ecs-task-role?ref=v0.36.0"
  project   = var.project
  env       = var.env
  service   = var.component
  owner     = var.owner
}

module "role-policy" {
  source    = "github.com/chanzuckerberg/cztack//aws-params-reader-policy?ref=v0.36.0"
  project   = var.project
  env       = var.env
  service   = var.component
  region    = var.region
  role_name = module.role.name
}

# This will define a task that runs this (example) container.
locals {
  template = <<TEMPLATE
[
  {
    "name": "myservice",
    "image": "chanzuckerberg/myservice:branch-master",
    "cpu": 1024,
    "memoryReservation": 1024,
    "essential": true,
    "portMappings": [
      {
        "containerPort": 80,
        "hostPort": 0        # If awsvpc_network_mode is true, must match containerPort so must be 80
      }
    ],
    "environment": [
      { "name": "AWS_REGION",           "value": "${var.region}" },
      { "name": "AWS_DEFAULT_REGION",   "value": "${var.region}" },
      { "name": "ENVIRONMENT",          "value": "${var.env}" },
    ],
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "${var.project}-${var.env}-myservice",
        "awslogs-region": "${var.region}",
        "awslogs-stream-prefix": "${var.container_name}"
      }
    }
  }
]
TEMPLATE
}

data "aws_acm_certificate" "staging" {
  domain   = var.hostname
  statuses = ["ISSUED"]
}

module "web-service" {
  source = "github.com/chanzuckerberg/cztack//aws-ecs-service?ref=v0.36.0"

  # this is the name of the service and many of the resources will have this name
  service = "myservice"

  # The number of tasks to run (no autoscaling currently)
  desired_count       = 2

  # These two together will set the domain name for your service.
  subdomain           = "myservice"
  route53_zone_id     = data.aws_route53_zone.zone.id

  # Parameters used for naming and tagging, auto-generated by fogg if you are using it.
  project = var.project
  owner   = var.owner
  env     = var.env

  # This port will exposed on this named container. This named container will also be
  # the one to which the load balancer points. The cert will be attached to the https listener.
  # The health of that contiainer will be checked with the `health_check_path` path.
  container_port      = 80
  container_name      = myservice
  acm_certificate_arn = data.aws_acm_certificate.staging.arn
  health_check_path   = "/health"

  # The VPC and subnets in which the load balancer will be created.
  vpc_id              = data.terraform_remote_state.cloud-env.outputs.vpc_id
  lb_subnets          = data.terraform_remote_state.cloud-env.outputs.public_subnets

  # The cluster in which the service is run.
  cluster_id          = data.terraform_remote_state.ecs.outputs.cluster_id
  # See above. This is what defines the containers that are run.
  task_definition     = local.template

  # The task is given this role. Useful for services that need to make API calls to AWS.
  task_role_arn       = module.role.arn

  with_service_discovery = true
}
```

## Service Discovery

In addition to a load balancer, this module supports registering all instances of
tasks with DNS via ECS service discovery. If with_service_discovery is true, a new private
DNS zone is created, and the tasks are registered in that DNS zone. The domain name is only
resolvable from within the VPC; it is not publicly resolvable.

## Migrating old ECS services
Older ECS services were created with an ARN in an old format that did not include the ECS cluster name as part of the ARN. AWS began allowing opt-in to the new ARN format starting November 15, 2018, and will require the new format starting January 1, 2020. ECS only allows applying tags (such as cost tags) on services that have the new ARN format. Applying tags to older ECS services using the old ARN format will return the following error message:
```
InvalidParameterException: Long arn format must be used for tagging operations
```
This module by default will assume your organization has opted in to the new ARN format and will apply tags to the ECS service. Creating new services after the opt-in will work fine, but migrating an existing older ECS service to using this module (via a state mv or an import) will encounter the above error message the next time it is applied.

Since changing a service to use the new ARN requires destroying and recreating the service, this can result in downtime. In such cases, you can opt-out applying tags by passing `tag_service = false` as an argument to the module. It is recommended that at the next possible down time, the ECS service be replaced by running `terraform taint`, and if `manage_task_definition = false` restoring the ECS task definition version (the taint/replace will restore to only the last stub definition). After the service is destroy/replaced, the `tag_
service = false` argument can be removed.

<!-- START -->
## Requirements

No requirements.

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | n/a |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_alb-sg"></a> [alb-sg](#module\_alb-sg) | terraform-aws-modules/security-group/aws | 4.3.0 |
| <a name="module_container-sg"></a> [container-sg](#module\_container-sg) | terraform-aws-modules/security-group/aws | 4.3.0 |

## Resources

| Name | Type |
|------|------|
| [aws_ecs_service.job](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_service) | resource |
| [aws_ecs_service.unmanaged-job](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_service) | resource |
| [aws_ecs_task_definition.job](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_task_definition) | resource |
| [aws_iam_role.task_execution_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role) | resource |
| [aws_iam_role_policy.task_execution_role_secretsmanager](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy) | resource |
| [aws_iam_role_policy_attachment.task_execution_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource |
| [aws_lb.service](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb) | resource |
| [aws_lb_listener.http](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_listener.https](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_listener) | resource |
| [aws_lb_target_group.service](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lb_target_group) | resource |
| [aws_route53_record.ipv4](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_route53_record.ipv6](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_route53_record.www-ipv4](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_route53_record.www-ipv6](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record) | resource |
| [aws_service_discovery_private_dns_namespace.discovery](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/service_discovery_private_dns_namespace) | resource |
| [aws_service_discovery_service.discovery](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/service_discovery_service) | resource |
| [aws_iam_policy_document.execution_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.registry_secretsmanager](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_route53_zone.zone](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_access_logs_bucket"></a> [access\_logs\_bucket](#input\_access\_logs\_bucket) | S3 bucket to write alb access logs to. Null for no access logs. | `string` | `null` | no |
| <a name="input_acm_certificate_arn"></a> [acm\_certificate\_arn](#input\_acm\_certificate\_arn) | Certificate for the HTTPS listener. | `string` | n/a | yes |
| <a name="input_awsvpc_network_mode"></a> [awsvpc\_network\_mode](#input\_awsvpc\_network\_mode) | Give the task its own IP and security group if true. Use host EC2 network if false. | `bool` | `false` | no |
| <a name="input_cluster_id"></a> [cluster\_id](#input\_cluster\_id) | n/a | `string` | n/a | yes |
| <a name="input_container_name"></a> [container\_name](#input\_container\_name) | Name of the container. Must match name in task definition. If omitted, defaults to name derived from project/env/service. | `string` | `null` | no |
| <a name="input_container_port"></a> [container\_port](#input\_container\_port) | The port the container to be exposed to is listening on. | `number` | n/a | yes |
| <a name="input_desired_count"></a> [desired\_count](#input\_desired\_count) | n/a | `number` | n/a | yes |
| <a name="input_disable_http_redirect"></a> [disable\_http\_redirect](#input\_disable\_http\_redirect) | Disable redirecting HTTP to HTTPS. | `bool` | `true` | no |
| <a name="input_env"></a> [env](#input\_env) | Env for tagging and naming. See [doc](../README.md#consistent-tagging). | `string` | n/a | yes |
| <a name="input_extra_tags"></a> [extra\_tags](#input\_extra\_tags) | Extra tags that will be added to components created by this module. | `map(string)` | `{}` | no |
| <a name="input_health_check_grace_period_seconds"></a> [health\_check\_grace\_period\_seconds](#input\_health\_check\_grace\_period\_seconds) | Seconds to ignore failing load balancer health checks on newly instantiated tasks to prevent premature shutdown, up to 7200. | `number` | `60` | no |
| <a name="input_health_check_interval"></a> [health\_check\_interval](#input\_health\_check\_interval) | Time between health checks of the underlying service. | `number` | `null` | no |
| <a name="input_health_check_matcher"></a> [health\_check\_matcher](#input\_health\_check\_matcher) | Range of HTTP status codes considered success for health checks. [Doc](https://www.terraform.io/docs/providers/aws/r/lb_target_group.html#matcher) | `string` | `"200-399"` | no |
| <a name="input_health_check_path"></a> [health\_check\_path](#input\_health\_check\_path) | n/a | `string` | `"/"` | no |
| <a name="input_health_check_timeout"></a> [health\_check\_timeout](#input\_health\_check\_timeout) | Timeout for a health check of the underlying service. | `number` | `null` | no |
| <a name="input_internal_lb"></a> [internal\_lb](#input\_internal\_lb) | n/a | `bool` | `false` | no |
| <a name="input_lb_idle_timeout_seconds"></a> [lb\_idle\_timeout\_seconds](#input\_lb\_idle\_timeout\_seconds) | n/a | `number` | `60` | no |
| <a name="input_lb_ingress_cidrs"></a> [lb\_ingress\_cidrs](#input\_lb\_ingress\_cidrs) | n/a | `list(string)` | <pre>[<br>  "0.0.0.0/0"<br>]</pre> | no |
| <a name="input_lb_ingress_security_group_ids"></a> [lb\_ingress\_security\_group\_ids](#input\_lb\_ingress\_security\_group\_ids) | n/a | `list(string)` | `[]` | no |
| <a name="input_lb_subnets"></a> [lb\_subnets](#input\_lb\_subnets) | List of subnets in which to deploy the load balancer. | `list(string)` | n/a | yes |
| <a name="input_manage_task_definition"></a> [manage\_task\_definition](#input\_manage\_task\_definition) | If false, Terraform will not touch the task definition for the ECS service after initial creation | `bool` | `true` | no |
| <a name="input_ordered_placement_strategy"></a> [ordered\_placement\_strategy](#input\_ordered\_placement\_strategy) | Placement strategy for the task instances. | `list(object({ type = string, field = string }))` | `[]` | no |
| <a name="input_owner"></a> [owner](#input\_owner) | Owner for tagging and naming. See [doc](../README.md#consistent-tagging). | `string` | n/a | yes |
| <a name="input_project"></a> [project](#input\_project) | Project for tagging and naming. See [doc](../README.md#consistent-tagging) | `string` | n/a | yes |
| <a name="input_registry_secretsmanager_arn"></a> [registry\_secretsmanager\_arn](#input\_registry\_secretsmanager\_arn) | ARN for AWS Secrets Manager secret for credentials to private registry | `string` | `null` | no |
| <a name="input_route53_zone_id"></a> [route53\_zone\_id](#input\_route53\_zone\_id) | Zone in which to create an alias record to the ALB. | `string` | n/a | yes |
| <a name="input_service"></a> [service](#input\_service) | Service for tagging and naming. See [doc](../README.md#consistent-tagging). | `string` | n/a | yes |
| <a name="input_slow_start"></a> [slow\_start](#input\_slow\_start) | Seconds for targets to warm up before the load balancer sends them a full share of requests. 30-900 seconds or 0 to disable. | `number` | `60` | no |
| <a name="input_ssl_policy"></a> [ssl\_policy](#input\_ssl\_policy) | ELB policy to determine which SSL/TLS encryption protocols are enabled. Probably don't touch this. | `string` | `null` | no |
| <a name="input_subdomain"></a> [subdomain](#input\_subdomain) | Subdomain in the zone. Final domain name will be subdomain.zone | `string` | n/a | yes |
| <a name="input_tag_service"></a> [tag\_service](#input\_tag\_service) | Apply cost tags to the ECS service. Only specify false for backwards compatibility with old ECS services. | `bool` | `true` | no |
| <a name="input_task_definition"></a> [task\_definition](#input\_task\_definition) | JSON to describe task. If omitted, defaults to a stub task that is expected to be managed outside of Terraform. | `string` | `null` | no |
| <a name="input_task_egress_cidrs"></a> [task\_egress\_cidrs](#input\_task\_egress\_cidrs) | CIDR blocks the task is allowed to communicate with for outbound traffic. Only used if awsvpc\_network\_mode is true. | `list(string)` | <pre>[<br>  "0.0.0.0/0"<br>]</pre> | no |
| <a name="input_task_egress_security_group_ids"></a> [task\_egress\_security\_group\_ids](#input\_task\_egress\_security\_group\_ids) | Security groups the task is allowed to communicate with for outbound traffic. Only used if awsvpc\_network\_mode is true. | `list(string)` | `[]` | no |
| <a name="input_task_role_arn"></a> [task\_role\_arn](#input\_task\_role\_arn) | n/a | `string` | n/a | yes |
| <a name="input_task_subnets"></a> [task\_subnets](#input\_task\_subnets) | List of subnets in which to deploy the task for awsvpc networking mode. Only used if awsvpc\_network\_mode is true. | `list(string)` | `[]` | no |
| <a name="input_volumes"></a> [volumes](#input\_volumes) | Volumes defined per the efs task definition [docs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ecs_task_definition#volume) | `list` | `[]` | no |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | n/a | `string` | n/a | yes |
| <a name="input_with_service_discovery"></a> [with\_service\_discovery](#input\_with\_service\_discovery) | Register the service with ECS service discovery. Adds a sub-zone to the given route53\_zone\_id. | `bool` | `false` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_alb_access_logs_prefix"></a> [alb\_access\_logs\_prefix](#output\_alb\_access\_logs\_prefix) | ALB access logs S3 prefix |
| <a name="output_alb_dns_name"></a> [alb\_dns\_name](#output\_alb\_dns\_name) | n/a |
| <a name="output_alb_http_listener_arn"></a> [alb\_http\_listener\_arn](#output\_alb\_http\_listener\_arn) | ALB HTTP listener ARN, only if HTTPS forwarding is disabled |
| <a name="output_alb_https_listener_arn"></a> [alb\_https\_listener\_arn](#output\_alb\_https\_listener\_arn) | ALB HTTPS listener ARN |
| <a name="output_alb_route53_zone_id"></a> [alb\_route53\_zone\_id](#output\_alb\_route53\_zone\_id) | n/a |
| <a name="output_container_security_group_id"></a> [container\_security\_group\_id](#output\_container\_security\_group\_id) | Security group id for the container. |
| <a name="output_ecs_task_definition_family"></a> [ecs\_task\_definition\_family](#output\_ecs\_task\_definition\_family) | The family of the task definition defined for the given/generated container definition. |
| <a name="output_private_service_discovery_domain"></a> [private\_service\_discovery\_domain](#output\_private\_service\_discovery\_domain) | Domain name for service discovery, if with\_service\_discovery=true. Only resolvable within the VPC. |
<!-- END -->
