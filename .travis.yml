language: go
go:
  - "1.10.3"
sudo: false
dist: trusty
cache: pip
install:
  - wget -t 10 -O terraform.zip https://releases.hashicorp.com/terraform/0.11.7/terraform_0.11.7_linux_amd64.zip
  - unzip terraform.zip
  - mv terraform ~/bin/
  - chmod +x ~/bin/terraform
  - wget -t 10 -O terraform-docs https://github.com/segmentio/terraform-docs/releases/download/v0.3.0/terraform-docs_linux_amd64
  - mv terraform-docs ~/bin/terraform-docs
  - chmod +x ~/bin/terraform-docs
  - pip install awscli --upgrade --user

jobs:
  include:
    - stage: check
      script: make lint
    - stage: check
      script: make check-docs
    - stage: check
      before_script:
        - aws configure set aws_access_key_id     $CI1_AWS_ACCESS_KEY_ID     --profile ci-1
        - aws configure set aws_secret_access_key $CI1_AWS_SECRET_ACCESS_KEY --profile ci-1
        - aws --profile ci-1 sts get-caller-identity

        - aws configure set aws_access_key_id     $CI2_AWS_ACCESS_KEY_ID     --profile ci-2
        - aws configure set aws_secret_access_key $CI2_AWS_SECRET_ACCESS_KEY --profile ci-2
        - aws --profile ci-2 sts get-caller-identity
      script: make test